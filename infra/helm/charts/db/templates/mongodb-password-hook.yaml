{{- if and .Values.auth.password (not .Values.auth.existingSecret) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "db.fullname" . }}-password-sync
  labels:
    {{- include "db.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-upgrade
    helm.sh/hook-weight: "-5"
    helm.sh/hook-delete-policy: hook-succeeded,hook-failed
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "db.selectorLabels" . | nindent 8 }}
    spec:
      securityContext:
        runAsNonRoot: true
      restartPolicy: Never
      containers:
        - name: password-sync
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          command: ["/bin/sh", "-c"]
          args:
            - |
              mongosh --host {{ include "db.fullname" . }} \
                -u "$OLD_USERNAME" -p "$OLD_PASSWORD" \
                --authenticationDatabase admin \
                --eval "db.adminCommand({updateUser: process.env.OLD_USERNAME, pwd: process.env.NEW_PASSWORD})"
          env:
            - name: OLD_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ include "db.secretName" . }}
                  key: MONGO_INITDB_ROOT_USERNAME
            - name: OLD_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "db.secretName" . }}
                  key: MONGO_INITDB_ROOT_PASSWORD
            - name: NEW_PASSWORD
              value: {{ .Values.auth.password | quote }}
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
{{- end }}
